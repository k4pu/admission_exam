# 高校向け受験情報DB

このアプリケーションは, **高校内のローカルネットワーク上で動作**する, 受験関連の情報を記録・管理するWebアプリケーションです. 校内サーバ上でホストされ, 校内の教員がアクセス・運用できます.

---

## 🔧 使用技術

- Docker / docker-compose
- Python 3.11-slim
- Django>=4.0,<5.0
- Nginx
- Gunicorn>=23.0,<24.0
- PostgreSQL (postgres:13)

---

## 💡 機能一覧

生徒の受験合否の記録を記録し, 大学学部別に表示するアプリです. ローカルネットワーク内のみでの公開を想定しています.

### 主な機能

- 受験情報の登録
    生徒リストから対象生徒を選択すると生徒詳細ページに遷移します. 生徒詳細ページから受験情報を登録できます（左下のリンクより）.
    - 大学・学部コードには大学名を一部入力するとオートコンプリートで候補が表示され、選択することができます.
    - 大学・学部コードを直接入力することも可能です.
- 登録されている生徒の一覧表示
    - 項目別のフィルタ機能をつけています.
    - 項目からは対象生徒の詳細ページに遷移します.
- 登録されている受験情報の一覧表示
    - 項目別のフィルタ機能をつけています.
    - 項目からは対象受験情報の編集ページに遷移します.
- 大学学部別の合格者数の一覧表示
    - 浪人生の合格者数はカッコ内に表示されます.
    - 項目からは大学別の一覧ページに遷移します.
    - さらにその項目からは受験情報の編集ページに遷移します.
- 蓄積データのダウンロード機能
    ダウンロードしたデータを表計算ソフトでの加工や他のDBシステムへの移行などを想定して, csvデータをダウンロードできるようにしています.
    ダウンロードできるデータは以下の通りです.
    - 生徒情報
    - 大学学部情報
    - 受験情報
    - 志望データのkey-value表
    - 受験結果データのkey-value表
- データのアップロード機能
    - 大学・学部データをまとめてアップロードできます.
    - 生徒データをまとめてアップロードできます.
    - 受験情報をまとめてアップロードできます（ダウンロードしたcsvファイルを利用したバックアップ目的）.
    - データを管理するユーザをcsvでまとめてアップロードできます. ここでのユーザはこの受験情報DBシステムにアクセスするユーザです.
    - アップロードするcsvのテンプレートは各々のページからダウンロード可能です.

### 認証機能

- ユーザのID, PW認証が可能です.
- 認証を行わないとどのページにもアクセスできません.

### 認可機能

- `editor`グループに所属するユーザまたはスーパーユーザのみ受験データの登録、編集、削除が可能です.

### ログ機能

- `log/`ディレクトリ以下にログが残ります.
- nginx, gunicorn, djangoそれぞれでログを取っています.
- nginx, gunicornではアクセスログとエラーログを取得します.
- djangoではデータベース内のレコードの更新（新規, 変更, 削除）が行われるたびにログ（どのユーザが変更を加えたかを含む）を残します.

---

## 📦 セットアップ方法

以下の手順で開発・テスト環境を構築できます.
- 事前にDockerデーモンは起動しておいてください. 
- docker-composeも必要です.
- コマンドを列挙していますが, 環境によっては`docker`や`docker-compose`には`sudo`が必要です.

```bash
systemctl start docker
```
など.

```bash
# リポジトリをクローン
git clone git@github.com:k4pu/admission_exam.git 
cd admission_exam_db

# 以降のコマンドはstudent_admission_exam_dbディレクトリで実行してください.

# logファイルの作成
touch ./log/{nginx, gunicorn, django}/{access.log error.log}

# .envファイルを作成
cp .env.sample .env  # 編集が必要
# この時点で.envファイルを編集し, ホストが所属するネットワーク（受験情報データベースシステムを公開するネットワーク）のプライベートIPアドレスをHOST_PRIVATE_IPに記述してください.

# Dockerコンテナ起動
docker-compose up --build -d

# マイグレーション
docker-compose exec web python3 manage.py makemigrations && docker-compose exec web python3 manage.py migrate

# サンプルデータのロード
cp ./fixtures/sample_data.json.sample ./fixtures/sample_data.json
docker-compose exec web python3 manage.py loaddata fixtures/sample_data.json
```

Dockerコンテナ起動後は
- ブラウザで[http://localhost/admission_exam_db/](http://localhost/admission_exam_db/)からアクセスできます.
- Django adminページには[http://localhost/admin/](http://localhost/admin/)からアクセスできます.
- ホストと同ネットワークに所属するノードからは[http://{ホストのプライベートIP}/admission_exam_db/](http://{ホストのプライベートIP}/admission_exam_db/)からアクセス可能です.
- サンプルアカウント一覧
    - adminアカウント:
        - ID: root
        - PW: rootpass
    - viewerアカウント:
        - ID: viewer
        - PW: viewpass
    - editorアカウント:
        - ID: editor
        - PW: editpass

---

## 🤖 仕様

- ユーザ関連の設定（editorグループに所属させるなど）は現状[http://localhost/admin/](http://localhost/admin/)のみから可能です.
- 大学・学部モデルと生徒モデルの連関エンティティとして受験情報モデルを用意したので浪人して同じ学部に再受験しても登録対応可能です. 大袈裟ですが第３正規化です.
- 主に学部データ対応ですが, データが巨大になるのでStreamingHttpResponseを利用しています.
- `docker-compose up` でデータベースサーバ用のコンテナ`db`, アプリケーションサーバ用のコンテナ`web`, リバースプロキシ用のコンテナ`nginx`が起動します.
- `nginx`コンテナへのアクセスはホスト側にポート80で開放しています.
- `web`コンテナへのアクセスはアプリ内のネットワークにポート8000で開放していますが, ホスト側には開放していません. ホスト側からは`nginx`コンテナを通してのみアクセス可能です.
- データの保存内容は特定の高校のローカルルールにかなり寄せているので, 他校で利用する際には調整した方が良いです.
- テストはデータモデルの作成段階レベルのもののみ実装しています（これもまだ不十分です）.

## ⚠️注意
- sample_data.jsonはあくまでダミーのデータです. 実在の人物とは関係がありません.

## 📚 今後の課題・改善点

1. テスト: 現状はデータモデルの作成段階でのテストのみ実装しています. 今後, フォームのバリデーションのテストも追加する予定です.
1. リファクタリング: ユーザの希望に沿うように変更をツギハギで加えていったので, コードに統一感がなく汚れてしまいました. きれいにしたいとは思っています.
1. コードとデータの分離: `models.py`に合格ステータスなどの選択肢を直接書き込んでいますが, jsonなど用意して分けるべきだと思っています.
1. UI/UXの改善: 現状あまりUIにはこだわることができませんでした.

## 📝 ライセンス

このプロジェクトは MIT License のもとで公開されています.

## 👤 作者情報

k4pu (sanponian@gmail.com)
